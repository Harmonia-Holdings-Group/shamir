<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SSSS | Shamir Secret Sharing Scheme</title>

  <script src="https://kit.fontawesome.com/fc88fc2226.js" crossorigin="anonymous"></script>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;800&family=Source+Code+Pro:wght@200;300;400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/main.css">

  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <script src="wasm/wasm_exec.js"></script>

</head>
<body>
  <header>
    <h1>SSSS</h1>
    <h2>Shamir Secret Sharing Scheme <i class="fas fa-user-lock"></i></i></h2>
  </header>

  <div id="nav">
    <div><a href="" class="active">Encrypt</a></div>
    <div><a href="">Decrypt</a></div>
  </div>

  <div id="main">
    <section class="container" id="encryption-input">
      <div class="file-input">
        <input type="file" id="file-input">
        <label for="file-input"><i class="fas fa-file"></i><span>Select file to encrypt</span></label>
      </div>
      <div class="input-group">
        <p class="accent">Key shares</p>
        <input type="number" min="3" placeholder="Key shares" id="key-shares-input">
        <label for="key-shares-input">Number of keys to generate after encryption. Min: 3</label>
      </div>
      <div class="input-group">
        <p class="accent">Keys threshold</p>
        <input type="number" placeholder="Key threshold" id="key-threshold-input">
        <label for="key-threshold-input">
          Minimum number of keys required to decrypt the file, must bet least 3, and at most
          the number of key shares.
        </label>
      </div>
      <div class="input-group">
        <p class="accent">Encryption password</p>
        <input type="password" placeholder="Enter a master password" id="encryption-password">
        <label for="encryption-password">Master password to encrypt the file.</label>
      </div>
      <div class="button">
        <button id="encrypt-button">Encrypt <i class="fas fa-play"></i></button>
      </div>
    </section>
  
    <section class="container" id="encryption-keys">
      <p class="subsection-title">Keys <i class="fas fa-copy"></i></p>
      <div class="keys">
        <ol id="gen-keys-result">
        </ol>
      </div>
    </section>
  
    <section class="container" id="encrypted-file">
      <p class="subsection-title">Encrypted file <i class="fas fa-copy"></i></p>
      <p><a href="data:application/octet-stream,charset=utf-16le;base64,hola">Save file <i class="fas fa-file-download"></i></a></p>
      <p class="small">
        Base64 encoded:
      </p>
      <p class="encoded" id="encrypted-file-content"></p>
    </section>
  </div>

  <div id="info">
    <div class="container">
      <h3>How it works?</h3>
      <p>
        The encrypted file is generated using
        <a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard"><b>AES</b></a>
        with a 256 bits key and the
        <a href="https://en.wikipedia.org/wiki/Galois/Counter_Mode">Galois/Counter Mode (GCM)</a>.
        To generate a 256 bits key from the given <b>encryption password</b> a fixed-size hash function is utilized,
        in this case, <a href="https://en.wikipedia.org/wiki/SHA-2"><b>SHA-256</b></a>
        to derive a key of 256 bits.
        The derived key is then
        considered the <b>the secret</b> part in the Shamir Secret Sharing Scheme, i.e: the independent term
        in the polynomial.
      </p>

      <h4><i>Shamir Secret Sharing Scheme:</i></h4>

      <p>
        Let \(n\) be the number of <b>key shares</b>, and \(n\) the <b>key threshold</b>, i.e: the minimum number of keys 
        required to obtain the derived key. To generate \(n\) keys, \(k-1\) positive integers are chosen at random such
        that every chosen integer is less that a positive prime value \(P\) and then a polynomial \(f(x)\) is built:
      </p>
      <p style="text-align: center;">
        \(f(x) = a_0 + a_1x + a_2x^2 + a_3x^3 + ... + a_{k-1}x^{k-1}\)
      </p>
      <p>
        Namely, a polynomial of degree \(k-1\).
        Finally, to obtain \(n\) keys, \(n\) points are evaluated at \(i = 1, ..., n\)
        to retrieve \((i, f(i))\) secrets.
      </p>
    </div>
  </div>

  <footer>
    <div class="container">
      <div>
        <p class="footer-title">Authors</p>
        <p><a href="">Pablo Trinidad</a></p>
        <p><a href="">Diego Jard√≥n</a></p>
      </div>
      <div>
        <p class="footer-title">Contribute</p>
        <p><a href="">GitHub Repository</a></p>
      </div>
    </div>
  </footer>

  <script>
    fileInputs = document.querySelectorAll('input[type=file]');
    Array.prototype.forEach.call(fileInputs, function(input) {
      var label = input.nextElementSibling,
          labelValue = label.innerHTML;

      input.addEventListener('change', function(e) {
        var fileName = e.target.value.split('\\').pop();

        if (fileName) {
          label.querySelector('span').innerHTML = fileName;
          label.querySelector('i').className += " green"
        } else {
          label.innerHTML = labelValue;
        }
      })
    })
  </script>

  <script>
    const go = new Go();
    WebAssembly.instantiateStreaming(fetch("wasm/main.wasm"), go.importObject).
      then((result) => {
        go.run(result.instance);

        var passwdInput = document.querySelector('#encryption-password');
        var submitButton = document.querySelector('#encrypt-button');
        var keysList = document.querySelector('#gen-keys-result');
        var fileInput = document.querySelector('#file-input');
        var encryptedFileContent = document.querySelector('#encrypted-file-content');

        submitButton.addEventListener('click', (e) => {
          e.preventDefault();

          var entry = document.createElement('li');
          var key = genKey(passwdInput.value);
          entry.innerHTML = key;
          keysList.innerHTML = "";
          keysList.appendChild(entry);

          var reader = new FileReader();
          reader.onload = function(e) {
            fileContent = e.target.result;
            content8 = new Uint8Array(fileContent);
            cipher = encryptWithKey(content8, key);
            encryptedFileContent.innerHTML = cipher;
          }
          if (fileInput.files.length === 1) {
            reader.readAsArrayBuffer(fileInput.files[0]);
          }
        });
      }).catch((error) => {
      console.log("CATCH");
        console.log(error)
      });
  </script>
</body>
</html>